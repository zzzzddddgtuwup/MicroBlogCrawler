<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="http://neo4j-contrib.github.io/developer-resources/language-guides/assets/css/main.css">
    <title>Weibo Analysis</title>
</head>

<body>
    <div id="graph">
    </div>
    <div role="navigation" class="navbar navbar-default navbar-static-top">
        <div class="container">
            <div class="row">
                <div class="navbar-header col-sm-6 col-md-6">
                    <div class="logo-well">
                        <a href="http://neo4j.com/developer-resources">
                            <img src="http://neo4j-contrib.github.io/developer-resources/language-guides/assets/img/logo-white.svg" alt="Neo4j World's Leading Graph Database" id="logo">
                        </a>
                    </div>
                    <div class="navbar-brand">
                        <div class="brand">Retweet network</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <style type="text/css">
        /*.node { stroke: #222; stroke-width: 1.5px; }*/
        circle {
          fill: #ccc;
          stroke: #222;
          stroke-width: 1.5px;
        }
        .link {stroke: #666; /*stroke-opacity: .6;*/stroke-width: 1.5px; }

        .link.REPOST {
            stroke: green;
        }

        text {
            fill: #000;
            font: 10px sans-serif;
            pointer-events: none;
        }
</style>

<script type="text/javascript" src="http://code.jquery.com/jquery-1.11.0.min.js"></script>
<script src="http://d3js.org/d3.v3.min.js" type="text/javascript"></script>
<script type="text/javascript">
    var scale_max = 2.3;
    var scale_min = 0.2;
    var current_scale = 1.1; 
    var bar_len = 100;
    var border_len = 20 ; 
    d3.xhr("http://localhost:7474/db/data/transaction/commit")
    .header("Content-Type", "application/json")
    .header("Accept","application/json; charset=UTF-8")
    .post(
        // JSON.stringify({"statements":[{"statement":"MATCH path = (n)-[r{tweetId:"3812215948115720"}]->(m) RETURN path","resultDataContents":["graph"]}]})
        JSON.stringify({"statements":[{"statement":"MATCH path = (n)-[r]->(m) RETURN path","resultDataContents":["graph"]}]})
        ,
        function(error, data){
            //if (error) return;
            var res = JSON.parse(data.response);
            // console.log("got response", JSON.parse(data.response).results[0].data);
            function idIndex(a,id) {
                for (var i=0;i<a.length;i++) {
                    if (a[i].id == id) return i;
                }
                return null;
            }
            var nodes=[], links=[];
            res.results[0].data.forEach(function (row) {
                row.graph.nodes.forEach(function (n) {
                    if (idIndex(nodes,n.id) == null)
                        nodes.push({id:n.id,label:n.labels[0],name:n.properties.name,uid:n.properties.id,time:n.properties.time});
                });
                links = links.concat( row.graph.relationships.map(function(r) {
                    return {source:idIndex(nodes,r.startNode),target:idIndex(nodes,r.endNode),type:r.type,time:r.properties.time};
                }));
            });
            viz = {nodes:nodes, links:links};
            //console.log(viz);

            var w = 2000, h = 1000;

            var force = d3.layout.force()
            .charge(-50).linkDistance(10).size([w, h])
            .nodes(viz.nodes).links(viz.links).on("tick", tick).start();

            var svg = d3.select("#graph")
                .append("svg")
                .attr("width", w)
                .attr("height", h)
                 .attr("pointer-events","all")     
                 .call(d3.behavior.zoom().on("zoom",redraw))//redraw
                .append('svg:g')
                .attr("cursor","pointer");

            // build the arrow.
            svg.append("svg:defs").selectAll("marker")
                .data(["end"])      // Different link/path types can be defined here
                .enter().append("svg:marker")    // This section adds in the arrows
                .attr("id", String)
                .attr("viewBox", "0 -5 10 10")
                .attr("refX", 15)
                .attr("refY", -1.5)
                .attr("markerWidth", 4)
                .attr("markerHeight", 4)
                .attr("orient", "auto")
                .append("svg:path")
                .attr("d", "M0,-5L10,0L0,5");

        var dtb = d3.select("svg")
                    .append("svg:g")
                    .attr({
                        heigth: bar_len,
                        width: 200 ,
                        x: 0,
                        y: 0 
                    });
            dtb.append('rect')//top
               .attr({
                    width:border_len,
                    height:border_len,
                    x: 10,
                    y: 10
               })
               .attr("fill",'black');
            dtb.append("rect") //bottom
               .attr({
                    width:border_len,
                    height:border_len,
                    x:10,
                    y:130
               })
               .attr("fill","black");
            dtb.append("rect")
                .attr({
                    width:4,
                    height:bar_len,
                    x:19,
                    y:30
                })
                .attr("fill","grey");

        var bar = dtb.append('rect')
                     .attr({
                        width:20,
                        height:5,
                        x: 10,
                        y: 82,
                        fill:"green",
                        cursor:"pointer"
                     })
                     .call(d3.behavior.drag().on("drag",dragmove));//dragmove


        //(3)创建作为连线的svg直线
        var edges = svg.append('g')
                .attr('cursor','pointer')
                .selectAll(".link")
                .data(force.links())
                .enter()
                .append("line")
                .attr("class","link")
                .attr("marker-end", "url(#end)");

            // define the nodes
            var node = svg.selectAll(".node")
                .data(force.nodes())
              .enter().append("g")
                .attr("class", "node")
                .call(force.drag);

            // add the nodes
            node.append("circle")
                .attr("r", 2);

            // add the curvy lines
            function tick() {
                edges.attr("x1",function(d){
                return  d.source.x;
                })
                .attr("y1",function(d){
                    return  d.source.y;
                })
                .attr("x2",function(d){
                    return  d.target.x;
                })
                .attr("y2",function(d){
                    return  d.target.y;
                });
        //(6)设置节点坐标，节点先生成再确定坐标的
            node.attr("cx",function(d){//节点有坐标属性
                    return d.x;
                })
                .attr("cy",function(d){
                    return d.y;
                }).attr("transform", function (d) {
                        return "translate(" + d.x + "," + d.y + ")";
                }); 
            }

        var scale = 1.1;
        var currentY = 0;
        function redraw(){  //放大缩小 鼠标滑动   scale放大倍数，translate是转变，转换

            scale = d3.event.scale;
            if(scale > scale_max || scale < scale_min){  
                return ;
            }
            currentY = scale/(scale_max-scale_min)*bar_len + 18;
            bar.attr("y",currentY);
            // console.log("scale:" + scale +",currentY:" + currentY); 
            svg.attr("transform","translate(" + d3.event.translate + ")" + "scale(" + scale + ")" ); 
        }        

        function dragmove(){ 
            var x = 0;   //not move in x axis
            var dy = d3.event.y; 
            var diffY = dy ;  //+currentY - 30 ; 

            if(diffY  > 130){//bar_len + border_len+ margin 
                diffY = 125;
                return ;
            }
            if(diffY < 30){ //border_len+ margin 
                diffY = 30;
                return ;
            }
            //console.log( "diffY:" + diffY + "dy:" + dy);
            scale = diffY /bar_len*(scale_max-scale_min);  
            //console.log("scale:" + scale); 
            bar.attr("y",diffY) 
            svg.attr("transform","translate(" + [(w/3)-(w*current_scale/3),(h/2) - (h*current_scale/2)] +")" + "scale(" + scale + ")" );
        }
        } 
    );
</script>
</body>
</html>
